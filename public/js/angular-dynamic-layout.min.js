/*
 angular-dynamic-layout 2015-09-13 
*/
!function(){"use strict";angular.module("dynamicLayout",["ngAnimate"])}(),function(){"use strict";function dynamicLayout($timeout,$window,$q,$animate,PositionService){function link(scope,element){function layout(){return PositionService.layout(element[0].offsetWidth)}function itemsLoaded(){var def=$q.defer();return $timeout(function(){0===scope.templatesToLoad&&def.resolve()}),scope.$watch("templatesToLoad",function(newValue,oldValue){newValue!==oldValue&&0===scope.templatesToLoad&&def.resolve()}),def.promise}function externalScope(){return scope.$parent}scope.templatesToLoad=0,scope.externalScope=externalScope,scope.$on("$includeContentRequested",function(){scope.templatesToLoad++}),scope.$on("$includeContentLoaded",function(){scope.templatesToLoad--}),scope.$watch("filteredItems",function(newValue,oldValue){scope.$parent.filteredItems=scope.filteredItems,angular.equals(newValue,oldValue)||itemsLoaded().then(function(){layout()})},!0),angular.element($window).bind("resize",function(){scope.$apply(function(){layout()})}),scope.$on("layout",function(event,callback){layout().then(function(){angular.isFunction("function")&&callback()})}),itemsLoaded().then(function(){layout()})}return{restrict:"A",scope:{items:"=",rankers:"=",filters:"=",defaulttemplate:"=?"},template:'<div                                                         class="dynamic-layout-item-parent"                        ng-repeat="it in items |                                             customFilter: filters |                                   customRanker:rankers |                                    as:this:\'filteredItems\'"                     ng-include="it.template || defaulttemplate"                 ></div>',link:link}}angular.module("dynamicLayout").directive("dynamicLayout",["$timeout","$window","$q","$animate","PositionService",dynamicLayout])}(),function(){"use strict";function layoutOnLoad($rootScope){return{restrict:"A",link:function(scope,element){element.bind("load error",function(){$rootScope.$broadcast("layout")})}}}angular.module("dynamicLayout").directive("layoutOnLoad",["$rootScope",layoutOnLoad])}(),function(){"use strict";function FilterService(){function applyFilters(items,filters){var i,retItems=[];for(i in items)checkAndGroup(items[i],filters)&&retItems.push(items[i]);return retItems}function checkStatement(item,statement){if(angular.isFunction(statement))return statement(item);var STATEMENT_LENGTH=3;if(statement.length<STATEMENT_LENGTH)throw"Incorrect statement";var property=statement[0],comparator=statement[1],value=statement[2];if(!item[property])return!1;switch(comparator){case"=":return item[property]===value;case"<":return item[property]<value;case"<=":return item[property]<=value;case">":return item[property]>value;case">=":return item[property]>=value;case"!=":return item[property]!==value;case"in":return item[property]in value;case"not in":return!(item[property]in value);case"contains":if(!(item[property]instanceof Array))throw"contains statement has to be applied on array";return item[property].indexOf(value)>-1;default:throw"Incorrect statement comparator: "+comparator}}function checkOrGroup(item,orGroup){var j;for(j in orGroup)if(checkStatement(item,orGroup[j]))return!0;return!1}function checkAndGroup(item,andGroup){var i;for(i in andGroup)if(!checkOrGroup(item,andGroup[i]))return!1;return!0}return{applyFilters:applyFilters}}angular.module("dynamicLayout").factory("FilterService",FilterService)}(),function(){"use strict";function PositionService($window,$document,$animate,$timeout,$q){function getItemsDimensionFromDOM(){elements=$document[0].querySelectorAll(".dynamic-layout-item-parent:not(.ng-leave)"),items=[];for(var i=0;i<elements.length;++i){var width,height,rect=elements[i].children[0].getBoundingClientRect();rect.width?(width=rect.width,height=rect.height):(width=rect.right-rect.left,height=rect.top-rect.bottom),items.push({height:height+parseFloat($window.getComputedStyle(elements[i]).marginTop),width:width+parseFloat($window.getComputedStyle(elements[i].children[0]).marginLeft)})}return items}function applyToDOM(){function launchAnimation(element,i){var animationPromise=$animate.addClass(element,"move-items-animation",{from:{position:"absolute"},to:{left:items[i].x+"px",top:items[i].y+"px"}});return animationPromise.then(function(){element.classList.remove("move-items-animation"),delete ongoingAnimations[i]}),animationPromise}function launchAnimations(){var i;for(i=0;i<items.length;++i)ongoingAnimations[i]=launchAnimation(elements[i],i);$q.all(ongoingAnimations).then(function(){ret.resolve()})}var ret=$q.defer();if(Object.keys(ongoingAnimations).length)for(var j in ongoingAnimations)$animate.cancel(ongoingAnimations[j]),delete ongoingAnimations[j];return $timeout(function(){launchAnimations(ret)}),ret.promise}function layout(containerWidth){items=self.getItemsDimensionFromDOM();var colSize=getColSize(),nbColumns=Math.floor(containerWidth/colSize);return initColumns(nbColumns),setItemsColumnSpan(colSize),setItemsPosition(columns,colSize),self.applyToDOM()}function getColumns(){return columns}function initColumns(nb){columns=[];var i;for(i=0;nb>i;++i)columns.push([]);return columns}function getColumnsHeights(cols){var i,columnsHeights=[];for(i in cols){var h;if(cols[i].length){var lastItem=cols[i][cols[i].length-1];h=lastItem.y+lastItem.height}else h=0;columnsHeights.push(h)}return columnsHeights}function getItemColumnsAndPosition(item,colHeights,colSize){if(item.columnSpan>colHeights.length)throw"Item too large";var i,indexOfMin=0,minFound=0;for(i=0;i<=colHeights.length-item.columnSpan;++i){var startingColumn=i,endingColumn=i+item.columnSpan,maxHeightInPart=Math.max.apply(Math,colHeights.slice(startingColumn,endingColumn));(0===i||minFound>maxHeightInPart)&&(minFound=maxHeightInPart,indexOfMin=i)}var itemColumns=[];for(i=indexOfMin;i<indexOfMin+item.columnSpan;++i)itemColumns.push(i);var position={x:itemColumns[0]*colSize,y:minFound};return{columns:itemColumns,position:position}}function setItemsPosition(cols,colSize){var i,j;for(i=0;i<items.length;++i){var columnsHeights=getColumnsHeights(cols),itemColumnsAndPosition=getItemColumnsAndPosition(items[i],columnsHeights,colSize);for(j in itemColumnsAndPosition.columns)columns[itemColumnsAndPosition.columns[j]].push(items[i]);items[i].x=itemColumnsAndPosition.position.x,items[i].y=itemColumnsAndPosition.position.y}}function getColSize(){var colSize,i;for(i=0;i<items.length;++i)(!colSize||items[i].width<colSize)&&(colSize=items[i].width);return colSize}function setItemsColumnSpan(colSize){var i;for(i=0;i<items.length;++i)items[i].columnSpan=Math.ceil(items[i].width/colSize)}var ongoingAnimations={},items=[],elements=[],columns=[],self={getItemsDimensionFromDOM:getItemsDimensionFromDOM,applyToDOM:applyToDOM,layout:layout,getColumns:getColumns};return self}angular.module("dynamicLayout").factory("PositionService",["$window","$document","$animate","$timeout","$q",PositionService])}(),function(){"use strict";function RankerService(){function applyRankers(items,rankers){function sorter(a,b){return i=0,recursiveRanker(a,b)}function recursiveRanker(a,b){var valueA,valueB,ranker=rankers[i][0],ascDesc=rankers[i][1];if(angular.isFunction(ranker))valueA=ranker(a),valueB=ranker(b);else{if(ranker in a||ranker in b){if(!(ranker in a))return"asc"===ascDesc?-1:1;if(!(ranker in b))return"asc"===ascDesc?1:-1}else valueA=0,valueB=0;valueA=a[ranker],valueB=b[ranker]}if(typeof valueA==typeof valueB)if(angular.isString(valueA)){var comp=valueA.localeCompare(valueB);if(1===comp)return"asc"===ascDesc?1:-1;if(-1===comp)return"asc"===ascDesc?-1:1}else{if(valueA>valueB)return"asc"===ascDesc?1:-1;if(valueB>valueA)return"asc"===ascDesc?-1:1}return++i,rankers.length>i?recursiveRanker(a,b):0}var i=0;return rankers&&items.sort(sorter),items}return{applyRankers:applyRankers}}angular.module("dynamicLayout").factory("RankerService",RankerService)}(),function(){"use strict";function as($parse){return function(value,context,path){return $parse(path).assign(context,value),value}}angular.module("dynamicLayout").filter("as",["$parse",as])}(),function(){"use strict";function customFilter(FilterService){return function(items,filters){return filters?FilterService.applyFilters(items,filters):items}}angular.module("dynamicLayout").filter("customFilter",["FilterService",customFilter])}(),function(){"use strict";function customRanker(RankerService){return function(items,rankers){return rankers?RankerService.applyRankers(items,rankers):items}}angular.module("dynamicLayout").filter("customRanker",["RankerService",customRanker])}();